# プロジェクト開発ルール

## Git ワークフロー

1. **作業ブランチ**

   - 原則として `main` ブランチでは直接作業を行わないでください。
   - 日常的な開発や修正は `develop` ブランチで行ってください。
   - 大きな機能追加や複雑な変更を行う場合は、`develop` から `feature/xxx` ブランチを作成して作業してください。

2. **作業開始前の確認**
   - 作業を開始する前に、必ず現在のブランチを確認してください（`git branch`）。
   - 意図しないブランチで作業しないよう、コミット前にも再度確認することを推奨します。

---

## コミットメッセージルール

このプロジェクトでは、コミットメッセージに **Conventional Commits** を適用します。

### フォーマット

```text
<type>: <description>

[optional body]
```

- `<type>` は英語で記述します。
- `<description>` は日本語で記述し、簡潔に変更内容を表現してください。
- 詳細な説明が必要な場合は、1 行空けて本文（body）を追記してください。

### `<type>` の種類

- `feat`: 新機能
- `fix`: バグ修正
- `docs`: ドキュメントのみの変更
- `style`: コードの動作に影響しない変更（空白、フォーマットなど）
- `refactor`: バグ修正や機能追加を行わないコードの変更
- `perf`: パフォーマンスを向上させるコードの変更
- `test`: テストの追加や修正
- `chore`: ビルドプロセスやドキュメント生成などの補助ツールやライブラリの変更

### 例

- `feat: X Pro用ユーザー非表示Tampermonkeyスクリプトの初期実装`
- `fix: 非表示ロジックのバグを修正`
- `docs: READMEにインストール手順を追加`

---

## コーディング規約

### JSDoc コメント

- クラス、メソッド、複雑な関数には **日本語で JSDoc コメント** を記述してください。

```javascript
/**
 * ユーザーIDリストを整形（トリム＋重複排除）する
 * @param {string[]} ids - 整形するユーザーIDの配列
 * @returns {string[]} 整形済みのユーザーID配列
 */
sanitizeIds (ids) {
  // ...
}
```

### アーキテクチャ

- コードは責務ごとにクラスに分割し、`App` クラスが全体のライフサイクルを管理する構成とします。
  - `ConfigManager`: 設定の読み込み・保存を担当
  - `FilterEngine`: 判定ロジックを担当
  - `App`: アプリケーションの初期化、各コンポーネントの連携、イベントハンドリングなど全体のオーケストレーションを担当

---

## 開発ワークフロー

### ビルド

- ソースコードは `src/` ディレクトリに配置されています。
- 変更後は必ずビルドを実行してください。

```bash
# 一度だけビルド
npm run build

# ファイル変更を監視して自動ビルド
npm run watch
```

- ビルド成果物は `dist/main.js` に出力されます。

### Tampermonkey へのインストール

1. `npm run build` でビルドを実行する。
2. `dist/main.js` の内容を Tampermonkey のスクリプトエディタにコピー＆ペーストして保存する。

### テスト

```bash
npm test
```

- 機能追加や挙動の変更を行った場合は、該当箇所のテストを追加・更新してください。
- テストがすべて通ることを必ず確認し、その結果に基づいて変更を進めてください。

---

## データエクスポートおよび非表示投稿ルール

このプロジェクトでは、投稿非表示情報を含むエクスポート仕様に関して、以下のルールを適用します。

1. **エクスポートバージョン**

   - エクスポートデータのバージョンは必ず `version: 2` とします。
   - 既存形式からの変更がある場合は、互換性への影響を確認したうえで仕様を更新してください。

2. **`hiddenPosts` の必須化**

   - エクスポートデータには `hiddenPosts` を必ず含めてください。
   - `hiddenPosts` には、少なくとも以下の情報を保持します。
     - 投稿 ID（post ID）
     - 有効期限（expiry / 期限日時）
   - フォーマット例（イメージ）：
     ```json
     {
       "version": 2,
       "hiddenPosts": [
         {
           "postId": "1234567890",
           "expiresAt": "2025-01-15T00:00:00Z"
         }
       ]
     }
     ```

3. **投稿非表示の TTL（有効期間）**
   - 投稿非表示の TTL（二重管理含め「基準値」）は **30 日固定** とします。
   - 特定の投稿を再度非表示対象として扱った場合（マッチした場合）は、その投稿の有効期限を **さらに 30 日延長** してください。
     - 例：現在の期限が 2025-01-10 のとき、再度マッチした場合、新たな期限は 2025-02-09（または同等の 30 日後）とする。
   - ページ読み込み時（初期化時）に、期限切れの `hiddenPosts` エントリを削除してください。
     - 削除はメモリ上だけでなく、永続化される設定（例：`ConfigManager` が管理するストレージ）からも除去する実装とすることが望ましい。

---

## 応答ルール

- このリポジトリに関する回答（レビューコメント、仕様確認、設計相談など）は、**必ず日本語** で行ってください。

---

## 作業完了後の確認事項

- 一連の作業完了後は、今回の変更・議論を振り返り、**AGENTS.md に追記すべきルールやナレッジがあれば提案** してください。
- コード変更を行った場合は、以下を必ず確認してください。
  - 関連ドキュメント（README、仕様書、コメントなど）の更新が必要かどうか。
  - エクスポート仕様や設定フォーマットに変更がある場合、それに対応する説明がドキュメントに反映されているか。
- 仕様追加・変更（特に `hiddenPosts` の扱い、TTL 仕様など）を実装した場合は、その内容を簡潔にまとめて AGENTS.md に記録し、今後の開発者が迷わないようにしてください。
