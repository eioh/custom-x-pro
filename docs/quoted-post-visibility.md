# 引用ポストの非表示判定ルール（ドラフト）

このドキュメントは、引用ポストを含むセルで「どの条件で非表示にするか」を決めるためのたたき台です。仕様を固めたのち、実装とテストを追加します。

## 用語
- 表示中ポスト: タイムライン上で表示されているポスト（引用している側）。`postId_parent`
- 引用元ポスト: 引用カード内に埋め込まれているポスト（引用されている側）。`postId_quoted`
- 非表示リスト:
  - `hiddenUserIds`: ユーザーIDベースの非表示
  - `hiddenPosts`: ポストIDベースの非表示（TTL 30 日、マッチ時にさらに 30 日延長）

## 前提
- `hiddenPosts` はエクスポート `version: 2` の必須フィールド。
- 期限切れの `hiddenPosts` は起動時に除去し、マッチ時に有効期限を延長する。
- 現行実装は「表示中ポストの ID」を持つセルだけを判定対象としている（引用元の ID 判定は未実装）。

## 判定ポリシー案
両ポスト（表示中・引用元）で非表示判定を行うための候補。最終方針を選定する。

### 案 A: 厳格非表示（全体）
- 以下のいずれかでセル全体を非表示
  - `postId_parent` が `hiddenPosts` に含まれる
  - `postId_quoted` が `hiddenPosts` に含まれる
  - 表示中ポストの投稿者が `hiddenUserIds` に含まれる
  - 引用元ポストの投稿者が `hiddenUserIds` に含まれる
- 影響: 引用元が非表示対象なら、引用しているポストも同時に消える（副作用が大きい）。

### 案 B: 引用カードのみ折りたたみ
- `postId_quoted` または引用元の投稿者が非表示対象の場合:
  - 引用カード部分のみ非表示（表示中ポスト本文は残す）
  - `hiddenPosts` に一致した場合も TTL を延長
- `postId_parent` や表示中の投稿者が非表示対象の場合:
  - セル全体を非表示（従来どおり）
- 影響: 引用元だけを抑制しつつ、引用コメントは確認できる。

### 案 C: 選択制
- ユーザー設定で「引用元まで隠すか」「引用元だけ隠すか」を切り替え。
- デフォルトは案 B（副作用を小さく）とし、厳格運用を選択可能にする。

## 判定テーブル（案 B を前提）
| 条件 | 動作 |
| --- | --- |
| `postId_parent` が hiddenPosts | セル全体を非表示（TTL 延長） |
| 表示中投稿者が hiddenUserIds | セル全体を非表示 |
| `postId_quoted` が hiddenPosts | 引用カードのみ非表示（TTL 延長） |
| 引用元投稿者が hiddenUserIds | 引用カードのみ非表示 |
| 上記以外 | 何もしない |

## 実装上のポイント（未着手）
- DOM 取得: 引用カード内のポスト ID・投稿者 ID を安定して取得できるセレクターの洗い出しが必要。
- TTL: 引用元マッチでも `hiddenPosts` の期限を 30 日延長する。
- エクスポート/インポート: 引用判定用に新フィールドを増やさず、既存 `hiddenPosts`/`hiddenUserIds` を流用する。
- UI: 引用のみ隠すモード（案 C）の場合は設定項目の追加が必要。
- テスト: 表示中のみ一致、引用元のみ一致、両方一致、どちらも不一致の4ケースを単体テストで網羅する。

## 未決事項
- 引用カードを隠す際の表示: 完全に除去するか、プレースホルダー（「引用元を非表示にしました」）を残すか。
- 取得できなかった引用元（ID不明）の扱い: 取得失敗時はスキップか、ログ出力のみか。
- 複数引用（引用の引用）をどう扱うか。
- パフォーマンス: 追加 DOM 探索のコストをどう抑えるか（キャッシュや1セル1回の検索に限定する等）。


## fBA\Ƃ̊֌W
- JŁufBA܂܂|Xĝݕ\v ColumnMediaFilter LȏꍇAfBÃZ͐ɏOBp|XǵA\Zɑ΂ēKpB
- pJ[ĥ݉BiBĵƂłAJ̃fBAtB^𖞂Ă邩D悷B
- ́AfBAtB^ZOꍇɈp胍WbNȂƂOɁApȏɂB
